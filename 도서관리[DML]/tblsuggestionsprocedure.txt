-- 1. 건의사항 정보 가져오기
create or replace procedure procgetsuggestions(
    presult out SYS_REFCURSOR
)
is
begin
    open presult for
    select sug.seq 글번호, sug.title 제목, mem.name 이름, to_char(sug.regdate,'yyyymmdd') 날짜 ,sug.sug_contents 건의사항, nvl(sug.answer,'답변') 답변, mem.tel 전화번호
    from tblsuggestions sug
        inner join tblmember mem
            on sug.member_seq=mem.seq
            where sug.delete_sug=0
            order by sug.regdate desc;
end;        

--2. 회원번호를 받아서(로그인 정보를 통해) 자신의 건의사항 확인하기
create or replace procedure procgetsuggestionsbymem_seq(
    presult out SYS_REFCURSOR,
    pmember_seq number
)
is
begin
    open presult for
    select sug.seq 글번호, sug.title 제목, mem.name 이름, to_char(sug.regdate,'yyyymmdd') 날짜 ,sug.sug_contents 건의사항, sug.answer 답변, mem.tel 전화번호
        from tblsuggestions sug
            inner join tblmember mem
                on sug.member_seq=mem.seq
                where mem.seq=pmember_seq and sug.delete_sug=0
                order by sug.regdate desc;
end;
--3. 글번호를 받아서 자신의 건의사항 내용 확인하기
create or replace procedure procgetsuggestionsbysug_seq(
    presult out SYS_REFCURSOR,
    psug_seq number
)
is
begin
    open presult for
    select sug.seq 글번호, sug.title 제목, mem.name 이름, to_char(sug.regdate,'yyyymmdd') 날짜 ,sug.sug_contents 건의사항, sug.answer 답변, mem.tel 전화번호
        from tblsuggestions sug
            inner join tblmember mem
                on sug.member_seq=mem.seq
                where sug.seq=psug_seq and sug.delete_sug=0
                order by sug.regdate desc;
end;

--4. 답변이 안된 건의사항 조회하기
create or replace procedure procgetsuggestionsnoanswer(
    presult out SYS_REFCURSOR,
    ptext varchar2 --오버로딩을 위한 인자
)
is
begin
    open presult for
    select sug.seq 글번호, sug.title 제목, mem.name 이름, to_char(sug.regdate,'yyyymmdd') 날짜 ,sug.sug_contents 건의사항, sug.answer 답변, mem.tel 전화번호
        from tblsuggestions sug
            inner join tblmember mem
                on sug.member_seq=mem.seq
                where sug.answer is null and sug.delete_sug=0
                order by sug.regdate desc;
end;
--5. 키워드를 입력받아 제목 검색하기
create or replace procedure procgetsuggestionsbykeyword
(
    presult out SYS_REFCURSOR,
    pkeyword varchar2
)
is
begin
    open presult for
    select sug.seq 글번호, sug.title 제목, mem.name 이름, to_char(sug.regdate,'yyyymmdd') 날짜 ,sug.sug_contents 건의사항, sug.answer 답변, mem.tel 전화번호
    from tblsuggestions sug
        inner join tblmember mem
            on sug.member_seq=mem.seq
            where sug.title like '%'||pkeyword||'%' and sug.delete_sug=0 
            order by sug.regdate desc;
end;
-- 6.건의사항 작성하기
create or replace procedure procsetsuggestion(
    pseq number,
    ptitle varchar2,
    pcontents varchar2
)
is
begin
    insert into tblsuggestions(seq,member_seq,title,sug_contents,regdate,delete_sug)  values((select max(seq)+1 from tblsuggestions),pseq,ptitle,pcontents,sysdate,0);
end;

-- 7. 게시글 삭제하기

create or replace procedure procsetdelsuggestion
(
    pseq number
)
is
begin
    update tblsuggestions set delete_sug=1 where seq=pseq;
end;

-- 8. 게시글 수정하기(회원)
create or replace procedure procsetsuggestionupdate(
    pseq number,
    ptitle varchar2,
    pcontents varchar2
)
is
begin
    update tblsuggestions set title=(case when ptitle is null then title else ptitle end), sug_contents=(case when pcontents is null then sug_contents else pcontents end), regdate=sysdate where seq=pseq;
end;

-- 9.(3과 연계) 건의사항에 답변 작성하기(답변 시간이 안나오네...)
create or replace procedure procsetsuggestionanswer(
    pseq number,
    panswer varchar2
)
is
begin
    update tblsuggestions set answer=panswer where seq=pseq;
end;

-- 10. 회원번호를 입력받아 글 가져오기
create or replace procedure procgetmysuggestions(
    presult out SYS_REFCURSOR,
    pmember_seq number
)
is
begin
    open presult for
     select sug.seq 글번호, sug.title 제목, mem.name 이름, to_char(sug.regdate,'yyyymmdd') 날짜 ,sug.sug_contents 건의사항, sug.answer 답변, mem.tel 전화번호
    from tblsuggestions sug
        inner join tblmember mem
            on sug.member_seq=mem.seq
            where sug.delete_sug=0 and mem.seq=pmember_seq
            order by sug.regdate desc;
end;

